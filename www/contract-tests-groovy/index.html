<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>

  <meta http-equiv="content-type" content="text/html; charset=windows-1250">
  <title>Groovy Contract Tests Manual</title>


</head>


<body style="color: rgb(0, 0, 0);" alink="#ee0000" link="#0000ee" vlink="#551a8b">

<h1>Groovy contract tests manual v0.2 <span style="color: rgb(51, 102, 255);">DRAFT</span><br>

</h1>

<span style="font-weight: bold;">Table of contents</span><br>

<span style="font-style: italic;"></span>
<ul>

  <li><a href="#Quick_start_guide">1 Quick start
guide</a></li>

  <ul>

    <li><a href="#Introduction_to_Groovy">1.1
Introduction
to Groovy</a></li>

    <li><a href="#Properties_files_location_and">1.2
Properties
files location and proprietary jars</a></li>

    <ul>

      <li><a href="#Proprietary_jars">Proprietary
jars</a></li>

    </ul>

  </ul>

  <ul>

    <li><a href="#A_Configuring_a_local_Connector">1.3
Configuring
a local Connector</a></li>

    <li><a href="#runcontractt">1.4 Running test</a></li>

    <ul>

      <li><a href="#Basic_usage">Basic usage</a></li>

      <li><a href="#runexport">Export of generated
test parameters</a></li>

      <li><a href="#runfile">Use of generated
property file</a></li>

    </ul>

  </ul>

  <li><a href="indepth.html">2 In-depth manual</a></li>

  <li>Running tests</li>

  <li>Connector servers</li>

  <li>Notation</li>

  <li><a href="appendix.html">A) Appendix</a></li>

<!-- former name: Gateway -->
</ul>

<hr style="width: 100%; height: 2px;">
<!-- ======================================================================== -->
<h2>Notation</h2>

<ul>

  <li><span style="font-style: italic;">properties
file = contract test configuration file = test configuration</span>
mean all
the same in this text.</li>

  <li> <span style="background-color: rgb(204, 204, 204);"><span style="font-family: monospace;"><span style="font-style: italic;">see In-depth guide: </span></span></span>
-- is marker for hyperlinks to the advanced guide. </li>

</ul>

<h1><a name="Quick_start_guide"></a>1. Quick
start guide</h1>

Contract test configuration files are Groovy scripts. So they
have to
respect syntax&nbsp;of the Groovy language. 98% of Java syntax will
work in Groovy also.&nbsp;For more information on Groovy see <a href="http://groovy.codehaus.org/">http://groovy.codehaus.org</a>.
Or see the <span style="font-weight: bold; color: rgb(255, 204, 0);">Groovy
TOI</span> -- make a link here...
<!-- ======================================================================== -->
<h2><a name="Introduction_to_Groovy"></a>1.1
Introduction
to Groovy</h2>

<p>Essential Groovy contructs used to configure contract tests
follow:</p>

<ul>

  <li>create a map: <span style="font-family: monospace;">map
= [key1 :&nbsp;value1, key2 : value2]</span>&nbsp;</li>

  <li>new list: <span style="font-family: monospace;">list
= [item1, item2]</span>&nbsp;</li>

  <li>calls of static contract test helpers: <span style="font-family: monospace;">Lazy.random()</span>, <span style="font-family: monospace;">Lazy.get()</span>.
These methods are evaluated just in time of user query.</li>

  <li>TIP: you can reduce repetition of the same prefix, for
instance state <span style="font-style: italic;">before</span>:<br>

    <pre>// path to bundle jar - property is set by ant - leave it as it is<br>testsuite.bundleJar=System.getProperty("connector-jar")<br>// ValidateApiOpTests:<br>testsuite.Validate.iterations="3"<br></pre>

    <a name="after"><span style="font-style: italic;">after</span>:</a><br>

    <pre>testsuite {<br>&nbsp;&nbsp;&nbsp; // path to bundle jar - property is set by ant - leave it as it is<br>&nbsp;&nbsp;&nbsp; bundleJar=System.getProperty("connector-jar")<br>&nbsp;&nbsp;&nbsp; // ValidateApiOpTests:<br>&nbsp;&nbsp;&nbsp; Validate.iterations="3"<br>}</pre>

  </li>

  <ul>

    <li>[PITFALL] in one
configuration file there could be only
one prefix defined, so in case of <a href="#after"><span style="font-family: monospace;">testsuite</span>
example</a> there
can't be more then one blocks with testsuite prefix in a single file.
E.g. following is invalid combination: <span style="font-family: monospace;">testsuite{...}
testsuite{...}</span> </li>

  </ul>

</ul>

Where key-value pairs, items are
typically&nbsp;<span style="font-family: monospace;">"quoted
strings"</span><!-- Note: This is not always true, as we can have nested lists allowed. -->.
Note that groovy scripts' <span style="font-style: italic;">properties</span>
use implicit type definition (no need to type <span style="font-family: monospace;">java.util.Map</span>
neither <span style="font-family: monospace;">List</span>
interfaces).<br>

<!-- [Advanced] Nested lists are allowed in the configuration files, however
mixing nested maps into lists is not supported.-->
<!-- ======================================================================== -->
<h2><a name="Properties_files_location_and"></a>1.2
Properties
files location and
proprietary jars</h2>

<table style="text-align: left; width: 100%;" border="5" cellpadding="2" cellspacing="2">

  <tbody>

    <tr>

      <td style="background-color: rgb(255, 255, 153);">Note:
This part will change due to Issue #312, difference will be in the
ordering of configuration files.</td>

    </tr>

  </tbody>
</table>

<p>Following directories hold the
contract test configurations:</p>

<ol>

  <li><span style="font-family: monospace;">{$user.home}/.bundle-name/contract-tests.groovy</span></li>

  <li><span style="font-family: monospace;">{$user.home}/.bundle-name-{$configuration}/contract-tests.groovy</span></li>

</ol>

<p>Latter properties files <strong>override
</strong>properties loaded from previous properties files.</p>

<table style="text-align: left; width: 100%;" border="0" cellpadding="2" cellspacing="2">

  <tbody>

    <tr>

      <td style="background-color: rgb(204, 204, 204);">Note:
      <span style="font-family: monospace;"><br>

      </span>
      <ul>

        <li><span style="font-family: monospace;">user-home</span>
would be <span style="font-family: monospace;">/home/john</span>
or <span style="font-family: monospace;">C:\Users\john</span>
on Unix or Windows platforms
typically.&nbsp;</li>

        <li><span style="font-family: monospace;">bundle-name</span>
equals the connector's <span style="font-family: monospace;">project
name</span> property, which resides in&nbsp;&nbsp;<span style="font-family: monospace;">build.xml</span>&nbsp;in
the connector's folder.</li>

        <li><span style="font-family: monospace;">${configuration}</span>
is to be replaced by resource specific configuration. For instance <span style="font-family: monospace;">databasetable</span>
connector can run against various databases, so in case of MySQL
configuration the folder name would be: <span style="font-family: monospace;">.databasetable-mysql</span>.</li>

      </ul>

      </td>

    </tr>

  </tbody>
</table>

<!-- ======================================================================== -->
<h3><a name="Proprietary_jars"></a>Proprietary
jars</h3>

Proprietary jars should not be checked-in
to versioning system. They
are located in<span style="font-family: monospace;"> \lib</span>
subdirectories of configuration specific folders:<br>

<ol>

  <li><span style="font-family: monospace;">user-home\.bundle-name\lib</span></li>

  <li><span style="font-family: monospace;">user-home\.bundle-name-{$configuration}\lib</span></li>

</ol>

<hr><!-- ======================================================================== -->
<h2><a name="A_Configuring_a_local_Connector"></a>1.3
Configuring
a local&nbsp;Connector</h2>

<p><span style="font-style: italic; color: rgb(153, 0, 0);">The
following
properties (from 1 to 6) will be defined in connector's property file:</span>
<span style="font-family: monospace;">{$user.home}\.bundle-name\contract-tests.groovy</span>.
The presented script fragments are from <a href="appendix.html#attachdbtableconfig">DatabaseTable
connector's
configuration files</a>.&nbsp;</p>

<ol>

  <li>define <span style="font-family: monospace;">testsuite.bundleJar</span>
property in connector's <span style="font-family: monospace;">contract-tests.groovy</span>
file:<br>

    <span style="font-family: monospace;">// path to
bundle jar - property is set by ant - leave it as it is</span><br>

    <span style="font-family: monospace;">testsuite.bundleJar=System.getProperty("connector-jar")</span><br>

    <br>

  </li>

  <li>define <span style="font-family: monospace;">connector.{$property.name}</span>&nbsp;for
each annotated connector configuration bean property (in class
implementing <a href="http://idmvm120.central.sun.com/hudson/job/framework/javadoc/org/identityconnectors/framework/spi/Configuration.html"><span style="font-family: monospace;">Configuration</span></a>
interface).<br>

    <span style="font-family: monospace;">// Connector
configuration</span><br>

    <span style="font-family: monospace;">connector.driver="com.mysql.jdbc.Driver"</span><br>

    <span style="font-family: monospace;">connector.keyColumn="ACCOUNTID"</span><br>

    <span style="font-family: monospace;">connector.passwordColumn="PASSWORD"</span><br>

    <span style="font-family: monospace;">connector.DBTable="idm_sync"</span><br>

    <span style="font-family: monospace;">connector.connectionUrl="jdbc:mysql://idmserv1.czech.sun.com/idm_sync"</span><br>

    <span style="font-family: monospace;">connector.login="testsuite"</span><br>

    <span style="font-family: monospace;">connector.password="testsuite"</span><br>

    <br>

    <span style="background-color: rgb(204, 204, 204);"> <span style="font-family: monospace;"><span style="font-style: italic;">see In-depth guide: </span></span></span><span style="color: rgb(255, 0, 0);">
sections Connector configuration properties for more details, and
section Defining properties to learn how the properties lookup works,
how to define properties values using macros and what are possible
properties types</span>. <span style="color: rgb(255, 102, 0); font-weight: bold;">TODO
TODO TODO</span> <br>

    <br>

  </li>

  <li>Provide number of iterations of <span style="font-family: monospace;">ValidateApiOpTests</span>
and at least one <strong>wrongly</strong> configured
property per each iteration. By wrongly configured property I mean
configured so that <a href="http://idmvm120.central.sun.com/hudson/job/framework/javadoc/org/identityconnectors/framework/spi/Configuration.html"><span style="font-family: monospace;">Configuration#validate</span></a>
method should fail. <br>

    <span style="font-family: monospace;">// Test will go
through 3 iterations</span><br>

    <span style="font-family: monospace;">Validate.iterations="3"</span><br>

    <br>

    <span style="font-family: monospace;">// Connector
WRONG configuration for ValidateApiOpTests</span><br>

    <br>

    <span style="font-family: monospace;">&nbsp;&nbsp;//
following
property will be used in the first iteration (must be at least one)</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;connector.i1.wrong.host=""
    </span><br>

    <br>

    <span style="font-family: monospace;">&nbsp;&nbsp;//
following
property will be used in the second iteration</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;connector.i2.wrong.login=""</span><br>

    <br>

    <span style="font-family: monospace;">&nbsp;&nbsp;//
following
property will be used in the third iteration</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;connector.i3.wrong.password=""</span><br>

    <br>

    <br>

  </li>

  <li>Define properties necessary to pass <a href="http://idmvm120.central.sun.com/hudson/job/framework/javadoc/org/identityconnectors/framework/api/operations/SchemaApiOp.html"><span style="font-family: monospace;">SchemaApiOpTests</span></a>.
    <br>

Define <span style="font-style: italic;">list</span>
of supported object classes by connector (see <a href="http://idmvm120.central.sun.com/hudson/job/framework/javadoc/org/identityconnectors/framework/common/objects/ObjectClass.html"><span style="font-family: monospace;">
ObjectClass.java</span></a> for up-to-date object class
types):<br>

    <span style="font-family: monospace;">// database
table connector supports only object class 'account'</span><br>

    <span style="font-family: monospace;">testsuite.Schema.oclasses=['account']</span>
    <br>

    <br>

Define list of attributes per <strong>each</strong>
supported object class:<br>

    <span style="font-family: monospace;">// list of ALL
attributes of object class 'account' for database table connector:</span><br>

    <span style="font-family: monospace;">testsuite.Schema.attributes.account.oclasses=['@@NAME@@',
'@@PASSWORD@@', 'MANAGER', 'MIDDLENAME', </span> (continued next
line)<br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
'FIRSTNAME', 'LASTNAME', 'EMAIL', 'DEPARTMENT', 'TITLE', 'AGE',
'SALARY', 'JPEGPHOTO']</span><br>

    <br>

Define <strong>every</strong> attribute of <strong>each</strong>
object class:<br>

    <span style="font-family: monospace;">// definition of
attribute @@NAME@@ of object class 'account' for databse table connector</span><br>

    <span style="font-family: monospace;">testsuite.Schema."@@NAME@@".attribute.account.oclasses=[</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
type:
'java.lang.String',</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
readable:
"true",</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
createable:
"true",</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
updateable:
"true",</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
required:
"true",</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
multiValue:
"false",</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
returnedByDefault: "true" </span><br>

    <span style="font-family: monospace;"> ]</span><br>

    <br>

    <br>

Define supported object classes by operations. Must contain <strong>exactly</strong>
the operations that are implemented by the connector:<br>

    <span style="font-family: monospace;">// object
classes supported by operations for database table connector</span><br>

    <span style="font-family: monospace;">Schema.operations=[</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
GetApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
SchemaApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
ValidateApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
CreateApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
SearchApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
DeleteApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
ScriptOnConnectorApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
UpdateApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
AuthenticationApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
TestApiOp: ['account'],</span><br>

    <span style="font-family: monospace;">&nbsp;&nbsp;
SyncApiOp: []</span><br>

    <span style="font-family: monospace;"> ]</span><br>

    <br>

    <br>

  </li>

  <li>Alternatively
define other <a href="indepth.html#optionalprops">Optional
properties</a> <span style="background-color: rgb(204, 204, 204);"><span style="font-family: monospace;">&nbsp;<span style="font-style: italic;">see In-depth guide</span></span>.</span></li>

  <li><strong>Howto run tests for a local connector</strong></li>

  <ul>

    <li>compile the connector: run <span style="font-family: monospace;">ant</span>
from the connector directory</li>

    <li>launch tests: issue command <span style="font-family: monospace;">ant run-contract-tests</span>
from the connector directory. For details see section&nbsp;<a href="#runcontractt">Running tests</a>.</li>

  </ul>

</ol>

<table style="text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="2">

  <tbody>

    <tr>

      <td style="background-color: rgb(204, 204, 255);"><!-- ******* --><strong>Troubleshooting
contract-test.groovy files</strong>
      <ul>

        <li>contract test <span style="font-weight: bold;">property
names</span> are:</li>

        <ul>

          <li>case sensitive</li>

          <li>must be valid Java identificators, OR invalid parts
of property name should be escaped, for instance<br>

&nbsp;-- WRONG:<br>

&nbsp;&nbsp;<span style="font-family: monospace;">testsuite.Schema.<span style="font-style: italic; color: rgb(51, 51, 255);">@@NAME@@</span>.attribute.account.oclasses</span>
or <span style="font-family: monospace;"><span style="font-style: italic; color: rgb(51, 51, 255);">"@@NAME@@"</span>.attribute.account.oclasses</span><br>

&nbsp;-- CORRECT:<br>

&nbsp;&nbsp;<span style="font-family: monospace;">testsuite.</span><span style="font-family: monospace;">Schema.<span style="color: rgb(204, 0, 0);">"</span>@@NAME@@<span style="color: rgb(204, 0, 0);">"</span>.attribute.account.oclasses</span><br>

            <br>

          </li>

        </ul>

        <li><a name="stdgroovyimports"></a>[<span style="font-weight: bold;">standard groovy imports</span>]
creation of any special object type is supported by
Groovy contract tests. By default Groovy imports six packages and two
classes: <span style="font-family: monospace;">java.lang.*,
&nbsp;java.util.*, &nbsp;java.io.*,
&nbsp;java.net.*, &nbsp;groovy.lang.*, groovy.util.*,
java.math.BigInteger, java.math.BigDecimal</span>. &nbsp;In
case &nbsp;you want &nbsp;to use additional types, add an
import to the &nbsp;start of you &nbsp;configuration file.<br>
          <br>
        </li>

        <li>[<span style="font-weight: bold; color: rgb(204, 0, 0);">contract
test specific imports</span>] don't forget to add the following
imports when you use Lazy proprety evaluation (optionally: your additional types) <br>

          <pre>import org.identityconnectors.contract.data.groovy.Lazy<br>import org.identityconnectors.contract.data.groovy.Random<br>import org.identityconnectors.contract.data.groovy.Get<br>import org.identityconnectors.contract.exceptions.ObjectNotFoundException;<br></pre>

        </li>

      </ul>

<!-- ******* --> </td>

    </tr>

  </tbody>
</table>

<span style="font-weight: bold; color: rgb(255, 204, 51);"><br>

<br>

</span>
<hr style="width: 100%; height: 2px;"><span style="font-weight: bold; color: rgb(255, 204, 51);"></span>
<h2><a name="runcontractt">1.4 Running tests</a></h2>

&nbsp;<span style="font-weight: bold;">Checkpoint:</span>
make sure that <span style="font-style: italic;">framework,
contract tests</span> and the <span style="font-style: italic;">connector to test</span>
are built by <span style="font-family: monospace;">
ant</span> (as a result&nbsp;<span style="font-family: monospace;">/dist</span>
folder will be created).<br>

<!-- TABLE -->
<table style="text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="2">

  <tbody>

    <tr>

      <td style="background-color: rgb(204, 204, 255);"><!-- ******* -->
      <strong>Simple steps for running contract tests:</strong>
      <ol>

        <li>First compile the Framework and Connector classes by
executing command <code>ant</code> in the <code>/framework</code>
and <code>/bundles/fooconnector</code> directories.</li>

        <li>To run the Contract tests go to directory of the
connector (e.g. <code>/bundles/fooconnector</code>) launch
in the command line: <code>ant run-contract-tests</code>. </li>

        <li>It is nice to have a HTML summary of the test
results, issue command for it: <code>ant report-junits</code>
. A new subdirectory <code>/reports</code> contains
overview of test results.</li>

      </ol>

<!-- ******* --> </td>

    </tr>

  </tbody>
</table>

<!-- EOF TABLE -->
<h3><a name="Basic_usage"></a>Basic usage</h3>

Contract test suite is run from within the connector directory with the
following command:
<pre>ant run-contract-tests<br></pre>

or in case connector has more test configurations:
<pre>ant -Dconfiguration=conf1 run-contract-tests<br></pre>

where <code>conf1</code> is configuration name. In this
case tests will use <code>{$user.home}\.{$project.name}-conf1.properties</code>
file.
<p></p>

<p>
When contract tests are run, there is created a new <code>connector.jar</code>
in <code>${connector.dir}/reports</code> directory. This
newly created <code>jar</code> contains
all the connector classes (excluding junit tests), all jars from <code>${connector.dir}/lib</code>
directory and proprietary jars from <code>${user.home}/.${project.name}/lib</code>
directory.
</p>

<h3><a name="runexport">Export of generated test
parameters</a></h3>

During the test there is generated a lot of parameters used as input
data for the tests. These can be exported to a property file to <strong>rerun</strong>
the test with the same values (Note: this file will contain all the
properties used during the test - <strong>configuration too</strong>).
To do that you need to pass the name of <a href="#runfile">generated
property file</a> in <code>test.parameters.outFile</code>
property.<br>

Example:
<pre># run contract tests and store all parameters (attributes values) used by tests in <code>test.properties</code> file<br>ant -Dtest.parameters.outFile=generated.properties run-contract-tests<br></pre>

<br>

<table style="text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="2">

  <tbody>

    <tr>

      <td style="background-color: rgb(204, 204, 255);">
<!-- ****** -->
      <h4><a name="runfile">Use of generated
property file</a></h4>

To instruct tests to use generated property file you need to pass its
filename in a <code>defaultdataprovider.propertyFile</code>
property.<br>

In this case the only file whose properties are loaded is the one
specified by <code>defaultdataprovider.propertyFile</code>.
Neither <code>build.properties</code> nor <code>${user.home}/.${project.name}.properties</code>
etc. are read in this case.<br>

Example:
      <pre>ant -Ddefaultdataprovider.propertyFile=generated.properties run-contract-tests<br></pre>

Running tests with property file generated by different test
configuration is <strong>not</strong> possible.
<!-- ****** --></td>

    </tr>

  </tbody>
</table>

<h3><a name="reports">Reports</a></h3>

JUnit XML reports are generated to <code>${connector.dir}/reports</code>
directory.
To see HTML reports run command <code>ant report-junits</code>
<p></p>

<h3><a name="eclipse">Running in Eclipse</a></h3>

<p>Create new JUnit run configuration and set values on tab <strong>Test</strong>
according to the following screenshot. Don't forget to set JUnit 4 <strong>Test
runner</strong>.</p>

<img src="../images/contract-tests/test.jpg" style="width: 999px; height: 720px;" alt="test.jpg"><br>

<p>On tab <strong>Arguments</strong> add following <strong>VM
arguments</strong>:
</p>

<ul>

  <li><code>-Dconfiguration=oracle</code> - optional,
set only in case you want to run particular configuration</li>

  <li><code>-Dproject.name=connector-databasetable</code>
- project name from <code>build.xml</code></li>

  <li><code>-Ddata-provider=org.identityconnectors.contract.data.<span style="font-weight: bold;">GroovyDataProvider</span></code>
- set exactly this value</li>

  <li><code>-Dconnector-jar=dist/org.identityconnectors.databasetable-1.0.x.jar</code>
- relative (to working directory) path to tested connector jar</li>

</ul>

[<span style="color: rgb(255, 0, 0);">!</span>]
Don't forget to change <strong>Working directory</strong>
to the tested connector project.
<p></p>

<img src="../images/contract-tests/arguments.jpg" style="width: 999px; height: 720px;" alt="arguments.jpg"><br>

<p>
Add all projects connector depends on to the <strong>Classpath</strong>
(you can debug then all) and also add references to all required
proprietary jars. </p>

<img src="../images/contract-tests/classpath.jpg" style="width: 999px; height: 720px;" alt="classpath.jpg"><br>

</body>
</html>
